// Service for Riskettan content API
const API_BASE_URL = process.env.NEXT_PUBLIC_BACKEND_URL || 'http://localhost:8000';

// TypeScript interfaces
export interface RiskettanBenefit {
  title: string;
  description: string;
  order: number;
  _id?: string;
}

export interface RiskettanCourseItem {
  title: string;
  order: number;
  _id?: string;
}

export interface RiskettanAdditionalInfo {
  title: string;
  description: string;
  order: number;
  _id?: string;
}

export interface RiskettanContentData {
  _id: string;
  pageContent: {
    title: string;
    description: string;
    mainTitle: string;
    subtitle: string;
    introText: string;
  };
  whyRisk1: {
    title: string;
    benefits: RiskettanBenefit[];
  };
  courseContent: {
    title: string;
    items: RiskettanCourseItem[];
  };
  additionalInfo: RiskettanAdditionalInfo[];
  createdAt: string;
  updatedAt: string;
}

export interface ApiResponse<T> {
  success: boolean;
  data?: T;
  message?: string;
  error?: string;
}

class RiskettanContentService {
  private baseUrl: string;
  private cache: RiskettanContentData | null = null;
  private cacheExpiry: number = 0;
  private readonly CACHE_DURATION = 5 * 60 * 1000; // 5 minutes
  
  // Language-specific caches
  private en_cache: RiskettanContentData | null = null;
  private sv_cache: RiskettanContentData | null = null;
  private ar_cache: RiskettanContentData | null = null;
  private en_expiry: number = 0;
  private sv_expiry: number = 0;
  private ar_expiry: number = 0;

  constructor() {
    this.baseUrl = `${API_BASE_URL}/api/riskettan-content`;
  }

  // Get Riskettan content with language support and caching
  async getRiskettanContent(lang: string = 'en'): Promise<RiskettanContentData | null> {
    try {
      // Get cache and expiry for specific language
      let cachedData: RiskettanContentData | null = null;
      let cacheExpiry: number = 0;
      
      switch (lang) {
        case 'sv':
          cachedData = this.sv_cache;
          cacheExpiry = this.sv_expiry;
          break;
        case 'ar':
          cachedData = this.ar_cache;
          cacheExpiry = this.ar_expiry;
          break;
        default: // 'en'
          cachedData = this.en_cache;
          cacheExpiry = this.en_expiry;
          break;
      }
      
      // Return cached data if valid for this language
      if (cachedData && Date.now() < cacheExpiry) {
        console.log(`üöÄ RiskettanContentService: Using cached data for ${lang.toUpperCase()}`);
        return cachedData;
      }

      console.log(`üåê RiskettanContentService: Fetching ${lang.toUpperCase()} content from API`);
      const response = await fetch(`${this.baseUrl}?lang=${lang}`, {
        method: 'GET',
        headers: {
          'Content-Type': 'application/json',
        },
        next: { revalidate: 300 }, // Revalidate every 5 minutes
      });

      if (!response.ok) {
        console.warn(`‚ö†Ô∏è API request failed with status ${response.status}, using fallback`);
        return this.getFallbackContent(lang);
      }

      const result: ApiResponse<any> = await response.json();
      
      if (result.success && result.data) {
        // Transform API response to frontend structure
        const transformedData = this.transformApiResponse(result.data, lang);
        
        // Update cache for this language
        const expiryTime = Date.now() + this.CACHE_DURATION;
        
        switch (lang) {
          case 'sv':
            this.sv_cache = transformedData;
            this.sv_expiry = expiryTime;
            break;
          case 'ar':
            this.ar_cache = transformedData;
            this.ar_expiry = expiryTime;
            break;
          default: // 'en'
            this.en_cache = transformedData;
            this.en_expiry = expiryTime;
            break;
        }
        
        console.log(`‚úÖ RiskettanContentService: ${lang.toUpperCase()} content fetched and transformed successfully from database`);
        return transformedData;
      } else {
        console.error('‚ùå RiskettanContentService: API returned unsuccessful response', result);
        return this.getFallbackContent(lang);
      }

    } catch (error) {
      console.error(`‚ùå RiskettanContentService: Error fetching ${lang.toUpperCase()} content:`, error);
      return this.getFallbackContent(lang);
    }
  }

  // Transform API response structure to frontend structure
  private transformApiResponse(apiData: any, lang: string): RiskettanContentData {
    return {
      _id: apiData._id || `fallback-${lang}`,
      pageContent: {
        title: apiData.hero?.title || apiData.course?.welcomeTitle || 'Risk 1 Course',
        description: apiData.hero?.description || apiData.course?.description || 'Learn essential driving skills and road safety regulations',
        mainTitle: apiData.course?.welcomeTitle || 'Complete Risk 1 Training Program',
        subtitle: apiData.course?.subtitle || 'Professional Driving Education',
        introText: apiData.course?.description || 'Our comprehensive Risk 1 course covers all fundamental aspects of safe driving'
      },
      whyRisk1: {
        title: apiData.course?.whyImportantTitle || 'Why Choose Risk 1 Course',
        benefits: (apiData.course?.benefits || []).map((benefit: any, index: number) => ({
          title: benefit.title || 'Benefit',
          description: benefit.description || 'Description',
          order: index + 1,
          _id: benefit._id
        }))
      },
      courseContent: {
        title: apiData.course?.courseContent?.title || 'Course Content Overview',
        items: (apiData.course?.courseContent?.items || []).map((item: any, index: number) => ({
          title: item || 'Course item',
          order: index + 1
        }))
      },
      additionalInfo: (apiData.course?.additionalInfo || []).map((info: any, index: number) => {
        // Handle both string and object formats
        if (typeof info === 'string') {
          return {
            title: 'Information',
            description: info,
            order: index + 1
          };
        } else {
          return {
            title: info.title || 'Information',
            description: info.description || info,
            order: index + 1,
            _id: info._id
          };
        }
      }),
      createdAt: apiData.createdAt || new Date().toISOString(),
      updatedAt: apiData.updatedAt || new Date().toISOString()
    };
  }

  // Fallback content with multi-language support
  private getFallbackContent(lang: string = 'en'): RiskettanContentData {
    const fallbacks = {
      en: {
        _id: 'fallback-en',
        pageContent: {
          title: "Riskettan Schedule and Prices",
          description: "Riskettan (Risk 1) training covers crucial aspects of road safety and traffic behavior, essential for obtaining your Swedish driving license. We offer flexible online schedules to fit your busy life, and competitive prices to ensure you get the best value. Enroll now and start your journey towards a safer driving experience.",
          mainTitle: "Risk1 Course at ABS Traffic School S√∂dert√§lje üößüö¶",
          subtitle: "Prepare for the challenges of the road with our Risk1 course!",
          introText: "At ABS Trafikskola S√∂dert√§lje, we offer a Risk1 course which is an important step in your driving education. This course is compulsory for anyone taking a car driving license and focuses on increasing awareness of risks in traffic."
        },
        whyRisk1: {
          title: "Why Risk1?",
          benefits: [
            {
              title: "Increased Safety",
              description: "Learn to manage and understand risks on the road.",
              order: 1
            },
            {
              title: "Important Knowledge",
              description: "The course covers important topics such as alcohol, drugs, fatigue and how these affect driving.",
              order: 2
            }
          ]
        },
        courseContent: {
          title: "Course Content",
          items: [
            {
              title: "Interactive and engaging training on road safety.",
              order: 1
            },
            {
              title: "Discussions and practical exercises.",
              order: 2
            }
          ]
        },
        additionalInfo: [
          {
            title: "Course Length and Certification:",
            description: "Risk training part 1 is approximately 3 hours long theoretical training, excluding breaks. After completing the course, we report directly to the Swedish Transport Agency online within 24 hours. Please note that no paper certificate is given to participants after the course.",
            order: 1
          },
          {
            title: "For More Information:",
            description: "Visit The Swedish Transport Agency's website for further information on the content and requirements of the Risk1 course.",
            order: 2
          },
          {
            title: "Get Ready:",
            description: "Get ready for a safer driving experience with our Risk1 course at ABS Trafikskola S√∂dert√§lje.",
            order: 3
          }
        ]
      },
      sv: {
        _id: 'fallback-sv',
        pageContent: {
          title: "Risk 1 Schema och Priser",
          description: "Risk 1-utbildning t√§cker viktiga aspekter av trafiks√§kerhet och trafikbeteende, n√∂dv√§ndigt f√∂r att f√• ditt svenska k√∂rkort. Vi erbjuder flexibla onlinescheman f√∂r att passa ditt upptagna liv och konkurrenskraftiga priser f√∂r att s√§kerst√§lla att du f√•r b√§sta v√§rdet. Anm√§l dig nu och b√∂rja din resa mot en s√§krare k√∂rupplevelse.",
          mainTitle: "Risk1-kurs p√• ABS Trafikskola S√∂dert√§lje üößüö¶",
          subtitle: "F√∂rbered dig f√∂r v√§gutmaningarna med v√•r Risk1-kurs!",
          introText: "P√• ABS Trafikskola S√∂dert√§lje erbjuder vi en Risk1-kurs som √§r ett viktigt steg i din k√∂rutbildning. Denna kurs √§r obligatorisk f√∂r alla som tar k√∂rkortsutbildning f√∂r bil och fokuserar p√• att √∂ka medvetenheten om risker i trafiken."
        },
        whyRisk1: {
          title: "Varf√∂r Risk1?",
          benefits: [
            {
              title: "√ñkad s√§kerhet",
              description: "L√§r dig hantera och f√∂rst√• risker p√• v√§gen.",
              order: 1
            },
            {
              title: "Viktig kunskap",
              description: "Kursen t√§cker viktiga √§mnen som alkohol, droger, tr√∂tthet och hur dessa p√•verkar k√∂rningen.",
              order: 2
            }
          ]
        },
        courseContent: {
          title: "Kursinneh√•ll",
          items: [
            {
              title: "Interaktiv och engagerande utbildning om trafiks√§kerhet.",
              order: 1
            },
            {
              title: "Diskussioner och praktiska √∂vningar.",
              order: 2
            }
          ]
        },
        additionalInfo: [
          {
            title: "Kursl√§ngd och certifiering:",
            description: "Riskutbildning del 1 √§r ungef√§r 3 timmar l√•ng teoretisk utbildning, exklusive pauser. Efter avslutad kurs rapporterar vi direkt till Transportstyrelsen online inom 24 timmar. Observera att inget papperscertifikat ges till deltagare efter kursen.",
            order: 1
          },
          {
            title: "F√∂r mer information:",
            description: "Bes√∂k Transportstyrelsens webbplats f√∂r ytterligare information om inneh√•llet och kraven f√∂r Risk1-kursen.",
            order: 2
          },
          {
            title: "G√∂r dig redo:",
            description: "G√∂r dig redo f√∂r en s√§krare k√∂rupplevelse med v√•r Risk1-kurs p√• ABS Trafikskola S√∂dert√§lje.",
            order: 3
          }
        ]
      },
      ar: {
        _id: 'fallback-ar',
        pageContent: {
          title: "ÿ¨ÿØŸàŸÑÿ© Ÿàÿ£ÿ≥ÿπÿßÿ± ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1",
          description: "ÿ™ÿØÿ±Ÿäÿ® ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1 Ÿäÿ∫ÿ∑Ÿä ÿßŸÑÿ¨ŸàÿßŸÜÿ® ÿßŸÑŸÖŸáŸÖÿ© ŸÑÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿ∑ÿ±ŸÇ Ÿàÿ≥ŸÑŸàŸÉ ÿßŸÑŸÖÿ±Ÿàÿ±ÿå ŸàŸáŸà ÿ∂ÿ±Ÿàÿ±Ÿä ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ÿ±ÿÆÿµÿ© ÿßŸÑŸÇŸäÿßÿØÿ© ÿßŸÑÿ≥ŸàŸäÿØŸäÿ©. ŸÜÿ≠ŸÜ ŸÜŸÇÿØŸÖ ÿ¨ÿØÿßŸàŸÑ ÿ≤ŸÖŸÜŸäÿ© ŸÖÿ±ŸÜÿ© ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÑÿ™ŸÜÿßÿ≥ÿ® ÿ≠Ÿäÿßÿ™ŸÉ ÿßŸÑŸÖÿ≤ÿØÿ≠ŸÖÿ©ÿå Ÿàÿ£ÿ≥ÿπÿßÿ± ÿ™ŸÜÿßŸÅÿ≥Ÿäÿ© ŸÑÿ∂ŸÖÿßŸÜ ÿ≠ÿµŸàŸÑŸÉ ÿπŸÑŸâ ÿ£ŸÅÿ∂ŸÑ ŸÇŸäŸÖÿ©. ÿ≥ÿ¨ŸÑ ÿßŸÑÿ¢ŸÜ Ÿàÿßÿ®ÿØÿ£ ÿ±ÿ≠ŸÑÿ™ŸÉ ŸÜÿ≠Ÿà ÿ™ÿ¨ÿ±ÿ®ÿ© ŸÇŸäÿßÿØÿ© ÿ£ŸÉÿ´ÿ± ÿ£ŸÖÿßŸÜŸãÿß.",
          mainTitle: "ÿØŸàÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1 ŸÅŸä ŸÖÿØÿ±ÿ≥ÿ© ABS ŸÑÿ™ÿπŸÑŸäŸÖ ÿßŸÑŸÇŸäÿßÿØÿ© ÿ≥ŸàÿØÿ±ÿ™ÿßŸÑŸäÿ© üößüö¶",
          subtitle: "ÿßÿ≥ÿ™ÿπÿØ ŸÑÿ™ÿ≠ÿØŸäÿßÿ™ ÿßŸÑÿ∑ÿ±ŸäŸÇ ŸÖÿπ ÿØŸàÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1 ÿßŸÑÿÆÿßÿµÿ© ÿ®ŸÜÿß!",
          introText: "ŸÅŸä ABS Trafikskola S√∂dert√§ljeÿå ŸÜŸÇÿØŸÖ ÿØŸàÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1 ŸàÿßŸÑÿ™Ÿä ÿ™ÿπÿ™ÿ®ÿ± ÿÆÿ∑Ÿàÿ© ŸÖŸáŸÖÿ© ŸÅŸä ÿ™ÿπŸÑŸäŸÖ ÿßŸÑŸÇŸäÿßÿØÿ© ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ. Ÿáÿ∞Ÿá ÿßŸÑÿØŸàÿ±ÿ© ÿ•ŸÑÿ≤ÿßŸÖŸäÿ© ŸÑÿ£Ÿä ÿ¥ÿÆÿµ Ÿäÿ£ÿÆÿ∞ ÿ±ÿÆÿµÿ© ŸÇŸäÿßÿØÿ© ÿßŸÑÿ≥Ÿäÿßÿ±ÿ© Ÿàÿ™ÿ±ŸÉÿ≤ ÿπŸÑŸâ ÿ≤ŸäÿßÿØÿ© ÿßŸÑŸàÿπŸä ÿ®ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ŸÅŸä ÿßŸÑŸÖÿ±Ÿàÿ±."
        },
        whyRisk1: {
          title: "ŸÑŸÖÿßÿ∞ÿß ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1ÿü",
          benefits: [
            {
              title: "ÿ≤ŸäÿßÿØÿ© ÿßŸÑÿ£ŸÖÿßŸÜ",
              description: "ÿ™ÿπŸÑŸÖ ŸÉŸäŸÅŸäÿ© ÿ•ÿØÿßÿ±ÿ© ŸàŸÅŸáŸÖ ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿπŸÑŸâ ÿßŸÑÿ∑ÿ±ŸäŸÇ.",
              order: 1
            },
            {
              title: "ŸÖÿπÿ±ŸÅÿ© ŸÖŸáŸÖÿ©",
              description: "ÿ™ÿ∫ÿ∑Ÿä ÿßŸÑÿØŸàÿ±ÿ© ŸÖŸàÿßÿ∂Ÿäÿπ ŸÖŸáŸÖÿ© ŸÖÿ´ŸÑ ÿßŸÑŸÉÿ≠ŸàŸÑ ŸàÿßŸÑŸÖÿÆÿØÿ±ÿßÿ™ ŸàÿßŸÑÿ™ÿπÿ® ŸàŸÉŸäŸÅ ÿ™ÿ§ÿ´ÿ± Ÿáÿ∞Ÿá ÿπŸÑŸâ ÿßŸÑŸÇŸäÿßÿØÿ©.",
              order: 2
            }
          ]
        },
        courseContent: {
          title: "ŸÖÿ≠ÿ™ŸàŸâ ÿßŸÑÿØŸàÿ±ÿ©",
          items: [
            {
              title: "ÿ™ÿØÿ±Ÿäÿ® ÿ™ŸÅÿßÿπŸÑŸä Ÿàÿ¨ÿ∞ÿßÿ® ÿπŸÑŸâ ÿ≥ŸÑÿßŸÖÿ© ÿßŸÑÿ∑ÿ±ŸÇ.",
              order: 1
            },
            {
              title: "ŸÖŸÜÿßŸÇÿ¥ÿßÿ™ Ÿàÿ™ŸÖÿßÿ±ŸäŸÜ ÿπŸÖŸÑŸäÿ©.",
              order: 2
            }
          ]
        },
        additionalInfo: [
          {
            title: "ŸÖÿØÿ© ÿßŸÑÿØŸàÿ±ÿ© ŸàÿßŸÑÿ¥ŸáÿßÿØÿ©:",
            description: "ÿ™ÿØÿ±Ÿäÿ® ÿßŸÑŸÖÿÆÿßÿ∑ÿ± ÿßŸÑÿ¨ÿ≤ÿ° 1 ŸáŸà ÿ™ÿØÿ±Ÿäÿ® ŸÜÿ∏ÿ±Ÿä Ÿäÿ≥ÿ™ÿ∫ÿ±ŸÇ ÿ≠ŸàÿßŸÑŸä 3 ÿ≥ÿßÿπÿßÿ™ÿå ÿ®ÿßÿ≥ÿ™ÿ´ŸÜÿßÿ° ŸÅÿ™ÿ±ÿßÿ™ ÿßŸÑÿ±ÿßÿ≠ÿ©. ÿ®ÿπÿØ ÿ•ŸÉŸÖÿßŸÑ ÿßŸÑÿØŸàÿ±ÿ©ÿå ŸÜŸÇŸàŸÖ ÿ®ÿßŸÑÿ•ÿ®ŸÑÿßÿ∫ ŸÖÿ®ÿßÿ¥ÿ±ÿ© ÿ•ŸÑŸâ ŸàŸÉÿßŸÑÿ© ÿßŸÑŸÜŸÇŸÑ ÿßŸÑÿ≥ŸàŸäÿØŸäÿ© ÿπÿ®ÿ± ÿßŸÑÿ•ŸÜÿ™ÿ±ŸÜÿ™ ŸÅŸä ÿ∫ÿ∂ŸàŸÜ 24 ÿ≥ÿßÿπÿ©. Ÿäÿ±ÿ¨Ÿâ ŸÖŸÑÿßÿ≠ÿ∏ÿ© ÿ£ŸÜŸá ŸÑÿß Ÿäÿ™ŸÖ ÿ•ÿπÿ∑ÿßÿ° ÿ¥ŸáÿßÿØÿ© Ÿàÿ±ŸÇŸäÿ© ŸÑŸÑŸÖÿ¥ÿßÿ±ŸÉŸäŸÜ ÿ®ÿπÿØ ÿßŸÑÿØŸàÿ±ÿ©.",
            order: 1
          },
          {
            title: "ŸÑŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™:",
            description: "ŸÇŸÖ ÿ®ÿ≤Ÿäÿßÿ±ÿ© ŸÖŸàŸÇÿπ ŸàŸÉÿßŸÑÿ© ÿßŸÑŸÜŸÇŸÑ ÿßŸÑÿ≥ŸàŸäÿØŸäÿ© ŸÑŸÑÿ≠ÿµŸàŸÑ ÿπŸÑŸâ ŸÖÿ≤ŸäÿØ ŸÖŸÜ ÿßŸÑŸÖÿπŸÑŸàŸÖÿßÿ™ ÿ≠ŸàŸÑ ŸÖÿ≠ÿ™ŸàŸâ ŸàŸÖÿ™ÿ∑ŸÑÿ®ÿßÿ™ ÿØŸàÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1.",
            order: 2
          },
          {
            title: "ÿßÿ≥ÿ™ÿπÿØ:",
            description: "ÿßÿ≥ÿ™ÿπÿØ ŸÑÿ™ÿ¨ÿ±ÿ®ÿ© ŸÇŸäÿßÿØÿ© ÿ£ŸÉÿ´ÿ± ÿ£ŸÖÿßŸÜŸãÿß ŸÖÿπ ÿØŸàÿ±ÿ© ÿßŸÑŸÖÿÆÿßÿ∑ÿ± 1 ŸÅŸä ABS Trafikskola S√∂dert√§lje.",
            order: 3
          }
        ]
      }
    };

    const selectedFallback = fallbacks[lang as keyof typeof fallbacks] || fallbacks.en;
    
    return {
      ...selectedFallback,
      createdAt: new Date().toISOString(),
      updatedAt: new Date().toISOString()
    };
  }

  // Clear cache for all languages (useful for admin updates)
  clearCache(): void {
    this.cache = null;
    this.cacheExpiry = 0;
    
    // Clear language-specific caches
    this.en_cache = null;
    this.sv_cache = null;
    this.ar_cache = null;
    this.en_expiry = 0;
    this.sv_expiry = 0;
    this.ar_expiry = 0;
    
    console.log('üóëÔ∏è RiskettanContentService: All caches cleared');
  }
}

// Export singleton instance
export const riskettanContentService = new RiskettanContentService();
